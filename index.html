
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Zarrar's Journaling</title>
  <meta name="author" content="Zarrar Shehzad">

  
  <meta name="description" content="I’ll go through the different changes in the CPAC centrality code that I’ve implemented. Normalized Timeseries The easiest change was to use &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://czarrar.github.io/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Zarrar's Journaling" type="application/atom+xml">
  <link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <div id="logo">
  	<div id="logoLeft">{</div>
  	<div id="logoText">mob</div>
  	<div id="logoRight">}</div>
  	<div class="clear"></div>
  </div>
  <h1><a href="/">Zarrar's Journaling</a></h1>
  
    <h2>To the edge and beyond</h2>
  
  <div class="clear"></div>
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:czarrar.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/blog/2013/11/25/updating-centrality/">Updating Centrality</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2013-11-25T10:26:00-05:00" pubdate data-updated="true">Nov 25<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I’ll go through the different changes in the CPAC centrality code that I’ve implemented.</p>

<h2 id="normalized-timeseries">Normalized Timeseries</h2>

<p>The easiest change was to use normalized time series, which then allows one to compute the crossproduct of the time series to calculate the correlations. Below are the relevant code slices that call on functions used in CWAS.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">timeseries</span> <span class="o">=</span> <span class="n">norm_cols</span><span class="p">(</span><span class="n">timeseries</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</span><span class="line"><span class="n">corr_matrix</span> <span class="o">=</span> <span class="n">timeseries</span><span class="p">[:,</span><span class="n">j</span><span class="p">:</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="block-size">Block Size</h2>

<p>We changed the block size to more accurately reflect the underlying operations. Although it should be noted that numpy has some poor memory handling as certain temporary objects will still be maintained in memory throwing off this calculation. However, later sections will show attempts to rectify this issue.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">nvoxs</span>   <span class="o">=</span> <span class="n">timeseries</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span class="line"><span class="n">ntpts</span>   <span class="o">=</span> <span class="n">timeseries</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span class="line"><span class="n">nbytes</span>  <span class="o">=</span> <span class="n">timeseries</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span>
</span><span class="line">
</span><span class="line"><span class="k">if</span> <span class="n">memory_allocated</span><span class="p">:</span>
</span><span class="line">    <span class="n">memory_in_bytes</span> <span class="o">=</span> <span class="n">memory_allocated</span> <span class="o">*</span> <span class="mf">1024.0</span><span class="o">**</span><span class="mi">3</span>    <span class="c"># assume it is in GB</span>
</span><span class="line">    <span class="n">block_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">memory_in_bytes</span><span class="o">/</span><span class="p">(</span><span class="n">nvoxs</span> <span class="o">*</span> <span class="n">nbytes</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">ntpts</span><span class="o">*</span><span class="n">nbytes</span> <span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="k">if</span> <span class="n">block_size</span> <span class="o">&gt;</span> <span class="n">nvoxs</span><span class="p">:</span>
</span><span class="line">    <span class="n">block_size</span> <span class="o">=</span> <span class="n">nvoxs</span>
</span><span class="line"><span class="k">elif</span> <span class="n">block_size</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span class="line">    <span class="k">raise</span> <span class="ne">MemoryError</span><span class="p">(</span><span class="s">&quot; Not enough memory available to perform degree centrality&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Note that the calculation is also dynamic with the data type of the time series.</p>

<h2 id="no-more-nan-to-number">No More NaN to Number</h2>

<p>This function <code>np.nan_to_num</code> is applied on the correlation matrix to turn any NaNs to 0s. This will occur when a time-series is all 0s leading to an error of sorts when calculating the correlation as you will be dividing by zeros and what not. The easiest way to avoid this error is to remove any flat time-series. I do this in the <code>load</code> function that initially reads in the time-series and the mask data.</p>

<p>I create an additional mask that is specific to the data. This is then combined with the externally defined template mask for a final mask at a later step.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">datmask</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span class="line"><span class="n">mask</span>    <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">template</span><span class="p">)</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="more-efficient-sum-of-thresholded-correlations">More Efficient Sum of Thresholded Correlations</h2>

<p>This particular step (below) is both slow and takes up a lot of memory. For instance the <code>corr_matrix &gt; r_value</code> must create a new copy of the matrix.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">corr_matrix</span> <span class="o">&gt;</span> <span class="n">r_value</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
</span><span class="line"><span class="sb">``</span>
</span><span class="line">
</span><span class="line"><span class="n">One</span> <span class="n">solution</span> <span class="ow">is</span> <span class="n">to</span> <span class="n">use</span> <span class="n">cython</span><span class="o">.</span> <span class="n">For</span> <span class="n">now</span><span class="p">,</span> <span class="n">I</span> <span class="n">will</span> <span class="n">do</span> <span class="n">this</span> <span class="n">without</span> <span class="n">compiling</span> <span class="n">the</span> <span class="n">whole</span> <span class="n">package</span> <span class="ow">and</span> <span class="n">use</span> <span class="sb">`pyxthon`</span> <span class="n">that</span> <span class="n">will</span> <span class="n">dynamically</span> <span class="nb">compile</span> <span class="n">the</span> <span class="n">new</span> <span class="n">function</span> <span class="n">at</span> <span class="n">runtime</span><span class="o">.</span> <span class="n">Below</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">cython</span> <span class="n">code</span><span class="o">.</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>python
def centrality_binarize_double(np.ndarray[double, ndim=2] cmat, np.ndarray[double, ndim=1] cent, double thresh):
    cdef unsigned int i,j
    for i in xrange(cmat.shape[0]):
        for j in xrange(cmat.shape[1]):
            cent[i] = cent[i] + 1<em>(cmat[i,j] &gt; thresh)
#
def centrality_weighted_double(np.ndarray[double, ndim=2] cmat, np.ndarray[double, ndim=1] cent, double thresh):
    cdef unsigned int i,j
    for i in xrange(cmat.shape[0]):
        for j in xrange(cmat.shape[1]):
            cent[i] = cent[i] + cmat[i,j]</em>(cmat[i,j] &gt; thresh)
&lt;div class=&#8217;bogus-wrapper&#8217;&gt;<notextile><figure class="code">&lt;figcaption&gt;<span></span>&lt;/figcaption&gt;&lt;div class=&#8221;highlight&#8221;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#8221;gutter&#8221;&gt;&lt;pre class=&#8221;line-numbers&#8221;&gt;<span class="line-number">1</span>
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#8217;code&#8217;&gt;&lt;pre&gt;<code class="python"><span class="line"><span class="n">I</span> <span class="n">created</span> <span class="n">a</span> <span class="n">wrapper</span> <span class="n">centrality</span> <span class="n">function</span> <span class="n">that</span> <span class="ow">is</span> <span class="n">fairly</span> <span class="n">straightforward</span><span class="o">.</span> <span class="n">It</span> <span class="n">allows</span> <span class="n">one</span> <span class="n">to</span> <span class="n">access</span> <span class="nb">all</span> <span class="n">the</span> <span class="n">different</span> <span class="n">C</span> <span class="n">functions</span> <span class="n">through</span> <span class="n">one</span> <span class="n">python</span> <span class="n">function</span><span class="o">.</span> <span class="n">I</span> <span class="n">also</span> <span class="n">wrote</span> <span class="mi">2</span> <span class="n">tests</span> <span class="n">that</span> <span class="n">both</span> <span class="n">passed</span><span class="o">.</span> <span class="n">Here</span><span class="s">&#39;s one example to illustrate the new functionality (`comp`) relative to the old (`ref`).</span>
</span></code>&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;</figure></notextile>&lt;/div&gt; python
def test_centrality_binarize():
    print “testing centrality binarize”</p>

<pre><code>method      = "binarize"
nblock      = 20
nvoxs       = 100
r_value     = 0.2
corr_matrix = np.random.random((nblock, nvoxs))

ref  = np.sum(corr_matrix&gt;r_value, axis=1)
comp = centrality(corr_matrix, r_value, method)

assert_equal(ref, comp) ```
</code></pre>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/blog/2013/11/25/monday-week-48/">Monday - Week 48</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2013-11-25T09:59:00-05:00" pubdate data-updated="true">Nov 25<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2 id="plans">Plans</h2>

<p>Today, I planned to work on…see summary section for what actually got done.</p>

<ul>
  <li>finish memory fixes to centrality code</li>
  <li>checking on the 3mm registration of ABIDE</li>
  <li>setup quick pack for Pierre &amp; Xinian’s data</li>
  <li>setup quick pack for ABIDE data (centrality and VMHC)</li>
</ul>

<h2 id="summary">Summary</h2>

<p>I wasn’t able to get through a lot that was planned. I worked on the following (described more later):</p>

<ul>
  <li>Centrality Coding</li>
  <li>Checking paths for ABIDE preprocessing</li>
</ul>

<h2 id="centrality-code">Centrality Code</h2>

<p>I updated the centrality code with several fixes and cleaned up some of the functions. Details of this work can be found on this <a href="/blog/2013/11/25/update-centrality">other post</a>.</p>

<h2 id="qc">QC</h2>

<p>The 3mm registration is done. I want to now take a closer look at the data. I want to take a look at a few things:</p>

<ul>
  <li>Are all the outputs there? Maybe make some type of table or record of what is good with what?</li>
  <li>Can we fix up the QC pages?</li>
  <li>Do the images look good?</li>
</ul>

<p>I began to create the code to find the needed paths in the preprocessing directory. This can be found in <code>/data/Projects/ABIDE_Initiative/CPAC/abide/config/24_check/10_check_path.py</code>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/blog/2013/11/24/timing-comparison/">Timing Comparison</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2013-11-24T15:21:00-05:00" pubdate data-updated="true">Nov 24<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2 id="overview">Overview</h2>

<p>I will be comparing the timing for the following functions:</p>

<ul>
  <li>Degree Centrality</li>
  <li>GLM</li>
  <li>MDMR</li>
  <li>SVM (linear)</li>
  <li>K-Means Clustering</li>
</ul>

<p>This order also reflects the speed result (first is faster).</p>

<h2 id="parameters">Parameters</h2>

<p>I examined the speed for examining connectivity-phenotype relationships for the following parameters:</p>

<ul>
  <li>number of nodes or connectivity maps: <strong>10</strong></li>
  <li>number of elements in each connectivity map: <strong>800</strong></li>
  <li>number of participants: <strong>100</strong></li>
  <li>number of iterations: <strong>100</strong></li>
</ul>

<p>In the case of SVM and K-Means, I did the analysis like I did with MDMR. I examined the fit between one connectivity map per participant and participant group membership. Thus, the analysis was repeated 10 times, one for each connectivity map.</p>

<p>This whole process was repeated 100 times.</p>

<h2 id="system">System</h2>

<p>The timing analysis was performed on a MacBook Pro OSX v10.8 using a 2.53GHz Intel Core 2 Duo with 4GB of RAM.</p>

<h2 id="results">Results</h2>

<p>A graph shows the average timing for each approach across 100 iterations below.</p>

<script type="text/javascript" src="https://www.google.com/jsapi"></script>

<script type="text/javascript">
  google.load("visualization", "1", {packages:["corechart"]});
  google.setOnLoadCallback(drawChart);
  function drawChart() {
    var data = google.visualization.arrayToDataTable([
      ['Method', 'Time'],
      ['Degree',  6],
      ['GLM',  		30],
      ['MDMR',  	52],
      ['SVM',  		229], 
		 ['K-Means', 788]
    ]);

    var options = {
      title: 'Average time (ms) to compute connectivity-phenotype association',
      hAxis: {title: 'Method'}, 
		 legend: {position: 'none'}
    };

    var chart = new google.visualization.ColumnChart(document.getElementById('chart_div'));
    chart.draw(data, options);
  }
</script>

<div id="chart_div" style="width: 500px; height: 300px;"></div>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/blog/2013/11/24/similarity-of-iq-cwas-across-scans/">Similarity of IQ CWAS Across Scans</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2013-11-24T11:51:00-05:00" pubdate data-updated="true">Nov 24<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Get the overlap (dice) and similarity (spearman) of the IQ CWAS between scans, and estimate the significance. Below are the current results for a simple comparison.</p>

<table>
  <thead>
    <tr>
      <th style="text-align: right">measures</th>
      <th>values</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: right">dice</td>
      <td>0.2731</td>
    </tr>
    <tr>
      <td style="text-align: right">pearson</td>
      <td>0.2571</td>
    </tr>
    <tr>
      <td style="text-align: right">spearman</td>
      <td>0.2511</td>
    </tr>
    <tr>
      <td style="text-align: right">kendalls</td>
      <td>0.1695</td>
    </tr>
  </tbody>
</table>

<p>Let’s focus on just the dice and spearman for now. For a proper permutation test, I want to make sure that the permuted subject indices are the same for scan 1 and 2. This would allow one to test the hypothesis of how similar the CWAS results for IQ are between scans when given a random list of participants.</p>

<h2 id="re-running-mdmr-for-scan-2">Re-Running MDMR for Scan 2</h2>

<p>This understanding mean I need to rerun the MDMR for scan 2 using the permutation indices from scan 1. I have created a new script to run these modified MDMR analyses for scan 2.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class=""><span class="line">cd /home2/data/Projects/CWAS/share/nki/05_cwas
</span><span class="line">./30_mdmr_using_perms.bash</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="permutations-for-dice-and-spearman">Permutations for dice and spearman</h2>

<p>Now we need to take the extra time to gather p-values for everything so we can threshold and compare. I’ll use some of the false positive code <code>share/results/20_cwas_iq/40_false_positives.R</code> in getting the p-values of the permutations. The result of this inspiration can be found in <code>/home2/data/Projects/CWAS/share/figures/fig_03</code> where I created the <code>E2_compare_scans.R</code> file. This script does the following (among other things):</p>

<ol>
  <li>Read in the permuted Fstats</li>
  <li>Loop through each permutation so you can</li>
  <li>Calculate significance for both scans</li>
  <li>Compare the two scans with dice (p &lt; 0.05) and spearman</li>
  <li>Return this result and loop to #3 for the next permutation</li>
</ol>

<p>Note that I’m not clustering correcting for the dice comparison and I’m using p-values here instead of F-stats.</p>

<h2 id="results">Results</h2>

<p>Highly significant with dice = 0.2731411 (p &lt; 0.001 or p = 0.0003) and spearman rho = 0.2510524 (p &lt; 0.005 or p = 0.004).</p>

<h2 id="update-connectir">Update Connectir</h2>

<p>To do this analysis, I updated the MDMR script to accept an external permutation file. This is with the new option <code>--permfiles</code>. It accepts a list of descriptor files (comma separated) that should reflect the number of factors2perm.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/blog/2013/11/23/saturday-week-47/">Saturday - Week 47</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2013-11-23T13:54:00-05:00" pubdate data-updated="true">Nov 23<span>rd</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This page covers both Saturday and Sunday (which is technically week 48).</p>

<h2 id="todo">TODO</h2>

<ul>
  <li><strong>Permutation test for dice and spearman with IQ CWAS</strong>
    <ul>
      <li><em>DONE</em></li>
    </ul>
  </li>
  <li><strong>Compare computational time for MDMR to other approaches</strong>
    <ul>
      <li><em>DONE</em></li>
    </ul>
  </li>
  <li><strong>Bootstrap analyses</strong>
    <ul>
      <li><em>DONE</em></li>
    </ul>
  </li>
  <li><strong>Compare different distances</strong>
    <ul>
      <li><em>DONE WITH TABLES</em></li>
      <li><em>GENERATE SURFACE RESULTS</em></li>
      <li><em>WRITE TEXT FOR PAPER</em></li>
      <li><em>UPDATE RESPONSE</em></li>
    </ul>
  </li>
  <li><strong>Simulations</strong>
    <ul>
      <li><em>WRITE CODE</em></li>
      <li><em>GENERATE PLOTS</em></li>
      <li><em>ADD TO RESPONSE LETTER</em></li>
    </ul>
  </li>
  <li><strong>Results</strong>
    <ul>
      <li><em>RE-COMPUTE WHERE NEEDED</em></li>
      <li><em>ADD TO PAPER</em></li>
    </ul>
  </li>
  <li><strong>Update paper with stuff from response letter</strong>
    <ul>
      <li><em>I guess waiting for feedback on response letter</em></li>
    </ul>
  </li>
</ul>

<h2 id="similarity-of-iq-cwas-across-scans">Similarity of IQ CWAS across scans</h2>

<p>See details at <a href="/2013/11/24/similarity-of-iq-cwas-across-scans/">my other post</a>.</p>

<p>Highly significant with dice = 0.2731411 (p &lt; 0.001 or p = 0.0003) and spearman rho = 0.2510524 (p &lt; 0.005 or p = 0.004).</p>

<h2 id="computational-time">Computational Time</h2>

<p>Below is the average time (ms) across 100 iterations. MDMR is a little slower than GLM but comparable.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">   method      time
1  Degree   5.76817
2     GLM  30.12167
3    MDMR  51.73251
4     SVM 228.89548
5 K-Means 788.41195</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Further details can be found on the <a href="/2013/11/24/timing-comparison/">following post</a>.</p>

<h2 id="comparing-distances">Comparing Distances</h2>

<p>Further details can be found on the <a href="/2013/11/09/comparing-distances">following post</a>.</p>

<h2 id="simulations">Simulations</h2>

<p>Getting a late start on the simulations. </p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/blog/2013/11/22/friday-week-47/">Friday - Week 47</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2013-11-22T15:44:00-05:00" pubdate data-updated="true">Nov 22<span>nd</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2 id="summary">Summary</h2>

<h3 id="centrality-and-memory">Centrality and Memory</h3>

<p>The conclusion from today’s work is that at three steps in the computation of centrality there is a huge spike in memory load that then stays there.</p>

<ol>
  <li>When computing the correlations, additional memory is allocated then that used for the output (up to 0.5x more).</li>
  <li>When converting any NaNs to 0s, more than 2x more than the current memory is used (I guess because a copy of the data is created but not wiped from memory at a later point).</li>
  <li>When calculating the degree centrality from the connectivity about 2x the amount of memory is used at this step.</li>
</ol>

<p>We actually can deal with step 2, since this only occurs because some time-series are flat or all zeros. If we mask those time series out in advance, then we don’t need to worry about that particular issue.</p>

<p>The third step might also be solved semi-easily with some cython. There is one nice tutorial/comparison here: http://technicaldiscovery.blogspot.com/2011/06/speeding-up-python-numpy-cython-and.html. We could then write a function that loops through the array, thresholds each element, and adds each element to a vector.</p>

<p>Further details are given below on examining memory issues in centrality using (1) 3mm brain and breakpoints and (2) a toy example to get more details.</p>

<h3 id="abide">ABIDE</h3>

<p>I began running CPAC to register the participant functional data and derivatives to 3mm space.</p>

<h2 id="memory-issues">Memory Issues</h2>

<p>There are a couple of nice pages on some memory issues with numpy. One suggestion was to upgrade to version 1.7.1+ where some memory leaks were fixed. I’m currently using version 1.6.1 so it’s possible using a more advanced version could help…however, I did check with a version of numpy Dan has and this didn’t solve my particular issues.</p>

<h2 id="detailed-memory-test">Detailed Memory Test</h2>

<p>I have put a few breakpoints in the centrality function to see where the memory blows up. I will record the memory usage based on <code>ps</code> at one of 4 points below. I really run the following command <code>./memtopX ./x_test_memprof.py</code>. I will be using 3mm data here.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">TODO</span><span class="p">:</span> <span class="n">breaks</span> <span class="n">pigments</span> <span class="n">will</span> <span class="nb">compile</span> <span class="n">elsewhere</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>block -&gt; 34382 0</p>

<ol>
  <li>93.88 MB</li>
  <li>139.12 MB</li>
  <li>6.45 GB (but note that before this point, memory goes up to 18.1GB)</li>
  <li>6.45 GB</li>
  <li>6.45 GB (but note that before this point, memory goes up to 13.75GB)</li>
</ol>

<p>block -&gt; 45262 34382</p>

<p>Also there was a second block so points 3-4 repeat. They both had 2.49 GB as that used.</p>

<p>Took about 324.71 secs or 5mins.</p>

<h2 id="for-our-sanity">For our Sanity</h2>

<p>So to confirm that we get sane numbers in python, one can run the following code and then monitor the memory externally with <code>./memtop</code>. Here, we will create a <code>corr_matrix</code> identical in size as in block 1 above. We find generally that our own calculation of this matrix is the same as that within python, which is the same as that using <code>memtop</code> (depends on <code>ps</code>). To get <code>memtop</code>, please follow this link: http://justinfranks.com/code/scripts/memtop.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
</span><span class="line">
</span><span class="line"><span class="n">nvoxs</span> <span class="o">=</span> <span class="mi">34382</span>
</span><span class="line"><span class="n">corr_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">nvoxs</span><span class="p">,</span> <span class="n">nvoxs</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">&#39;float32&#39;</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="c"># Our assumption (4.4GB)</span>
</span><span class="line"><span class="n">size_us</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">nvoxs</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="mi">1024</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="c"># Using numpy (4.4GB)</span>
</span><span class="line"><span class="n">size_np</span> <span class="o">=</span> <span class="n">corr_matrix</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="mi">1024</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="c"># From the command-line (4.45GB)</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">os</span>
</span><span class="line"><span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;./memtop | grep ipython&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="understanding-memory-for-dot-product">Understanding memory for dot product</h2>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">import</span> <span class="nn">sys</span>
</span><span class="line"><span class="n">sys</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;/home2/dlurie/Enthought/Canopy_64bit/User/lib/python2.7/site-packages/nibabel-1.3.0-py2.7.egg&#39;</span><span class="p">,</span> <span class="s">&#39;/home2/dlurie/Enthought/Canopy_64bit/User/lib/python2.7/site-packages/pydicom-0.9.8-py2.7.egg&#39;</span><span class="p">,</span> <span class="s">&#39;/home2/dlurie/Enthought/Canopy_64bit/User/lib/python2.7/site-packages/networkx-1.7-py2.7.egg&#39;</span><span class="p">,</span> <span class="s">&#39;/home2/dlurie/Enthought/Canopy_64bit/User/lib/python2.7/site-packages/pysurfer-0.3.1-py2.7.egg&#39;</span><span class="p">,</span> <span class="s">&#39;/home2/dlurie/Canopy/appdata/canopy-1.0.3.1262.rh5-x86_64/lib/python27.zip&#39;</span><span class="p">,</span> <span class="s">&#39;/home2/dlurie/Canopy/appdata/canopy-1.0.3.1262.rh5-x86_64/lib/python2.7&#39;</span><span class="p">,</span> <span class="s">&#39;/home2/dlurie/Canopy/appdata/canopy-1.0.3.1262.rh5-x86_64/lib/python2.7/plat-linux2&#39;</span><span class="p">,</span> <span class="s">&#39;/home2/dlurie/Canopy/appdata/canopy-1.0.3.1262.rh5-x86_64/lib/python2.7/lib-tk&#39;</span><span class="p">,</span> <span class="s">&#39;/home2/dlurie/Canopy/appdata/canopy-1.0.3.1262.rh5-x86_64/lib/python2.7/lib-old&#39;</span><span class="p">,</span> <span class="s">&#39;/home2/dlurie/Canopy/appdata/canopy-1.0.3.1262.rh5-x86_64/lib/python2.7/lib-dynload&#39;</span><span class="p">,</span> <span class="s">&#39;/home2/dlurie/Enthought/Canopy_64bit/User/lib/python2.7/site-packages&#39;</span><span class="p">,</span> <span class="s">&#39;/home2/dlurie/Enthought/Canopy_64bit/System/lib/python2.7/site-packages&#39;</span><span class="p">,</span> <span class="s">&#39;/home2/dlurie/Enthought/Canopy_64bit/System/lib/python2.7/site-packages/PIL&#39;</span><span class="p">,</span> <span class="s">&#39;/home2/dlurie/Canopy/appdata/canopy-1.0.3.1262.rh5-x86_64/lib/python2.7/site-packages&#39;</span><span class="p">]</span>
</span><span class="line">
</span><span class="line"><span class="c"># Note there is a base memory of 84.86  MB</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
</span><span class="line"><span class="n">npsize</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">nbytes</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="mi">1024</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="n">nvoxs</span> <span class="o">=</span> <span class="mi">10000</span>
</span><span class="line"><span class="n">ntpts</span> <span class="o">=</span> <span class="mi">150</span>
</span><span class="line">
</span><span class="line"><span class="c"># There is an increase to 100.7 MB with the time series</span>
</span><span class="line"><span class="c"># this is a little larger then it&#39;s 11.5MB size</span>
</span><span class="line"><span class="n">timeseries</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="n">nvoxs</span><span class="p">,</span><span class="n">ntpts</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
</span><span class="line"><span class="n">timeseries</span><span class="p">[:,</span><span class="mi">100</span><span class="p">:</span><span class="mi">104</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class="line">
</span><span class="line"><span class="c"># to 863.73 MB</span>
</span><span class="line"><span class="n">corr_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nvoxs</span><span class="p">,</span><span class="n">nvoxs</span><span class="p">))</span>
</span><span class="line">
</span><span class="line"><span class="c"># to 1.35 GB (even after it is done)</span>
</span><span class="line"><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">timeseries</span><span class="o">.</span><span class="n">T</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="n">nvoxs</span><span class="p">],</span> <span class="n">timeseries</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">corr_matrix</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="c"># to 2.47 GB but stays at 2.09 GB</span>
</span><span class="line"><span class="n">corr_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">corr_matrix</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="c"># still at 2.09 GB</span>
</span><span class="line"><span class="n">degree_centrality_weighted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nvoxs</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="c"># to 3.68 GB but stays at 2.84 GB</span>
</span><span class="line"><span class="n">r_value</span> <span class="o">=</span> <span class="mf">0.2</span>
</span><span class="line"><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">corr_matrix</span><span class="o">*</span><span class="p">(</span><span class="n">corr_matrix</span> <span class="o">&gt;</span> <span class="n">r_value</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">degree_centrality_weighted</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="c"># Note that theoretically, we might have thought a limit of 0.75 GB</span>
</span><span class="line"><span class="p">(</span><span class="n">nvoxs</span><span class="o">*</span><span class="n">nvoxs</span> <span class="o">+</span> <span class="n">nvoxs</span> <span class="o">+</span> <span class="n">nvoxs</span><span class="o">*</span><span class="n">ntpts</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="mi">1024</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Below is the parallel commands that I ran to monitor the memory usage above.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">./memtop | grep ipython <span class="c"># get the pid</span>
</span><span class="line"><span class="nv">PID</span><span class="o">=</span>7873
</span><span class="line"><span class="k">while</span> <span class="o">[[</span> True <span class="o">]]</span>; <span class="k">do</span>
</span><span class="line">	./memtop -s -p <span class="nv">$PID</span>
</span><span class="line">	sleep 0.5
</span><span class="line"><span class="k">done</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="memory-leakage-links">Memory Leakage Links</h2>

<ul>
  <li>http://stackoverflow.com/questions/12422307/reducing-numpy-memory-footprint-in-long-running-application</li>
  <li>http://stackoverflow.com/questions/12461413/why-does-comparison-of-a-numpy-array-with-a-list-consume-so-much-memory</li>
  <li>http://stackoverflow.com/questions/15191391/how-to-avoid-this-four-line-memory-leak-with-numpymkl</li>
</ul>

<h2 id="running-centrality-on-abide">Running Centrality on ABIDE</h2>

<p>The usage approaches 18GB when I set a 12GB limit. On gelert, each node has about 16GB of RAM. The easiest thing might be to run one process on each node with a limit of 6GB to keep well within range.</p>

<h2 id="registering-data-to-3mm-space">Registering Data to 3mm Space</h2>

<p>I also want to redo the registration to be in 3mm standard space, whereas it currently is in 2mm. I’m working on the script for that task and have started running this on gelert now.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/blog/2013/11/21/thursday-week-47/">Thursday - Week 47</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2013-11-21T11:34:00-05:00" pubdate data-updated="true">Nov 21<span>st</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Today mostly revolved around memory profiling to work in python. Summary is as follows.</p>

<ul>
  <li>Looked into memory profiling
    <ul>
      <li>Had issues with memprof but got heapy to work (links below).</li>
      <li>Got memprof to work not through numpy</li>
      <li>Also applied memory_profiler (a little bit more accurate and useful than memprof).</li>
      <li>Finally also applied memtop (a wrapper around ps)</li>
    </ul>
  </li>
  <li>Attended lab meeting</li>
  <li>Discussion of ABIDE with Chao-Gan and then Cameron</li>
</ul>

<h2 id="memory-profiling">Memory Profiling</h2>

<p>Want to examine the memory usage of centrality in CPAC.</p>

<h3 id="choosing-a-package">Choosing a Package</h3>

<p>There are several python packages available with an extensive list available on stackoverflow: http://stackoverflow.com/questions/110259/which-python-memory-profiler-is-recommended.</p>

<p>Some that do not seem appropriate for our purposes:</p>

<ul>
  <li><a href="https://launchpad.net/meliae">Meliae</a>: No documentation.</li>
  <li><a href="http://pythonhosted.org/Pympler/muppy.html">Muppy</a>: Not that useful.</li>
</ul>

<p>One particular issue that I’ll be dealing with are how well it will work with nipype.</p>

<h3 id="path-issue">Path Issue</h3>

<p>The first problem I faced was the memory profiling not being on the path. This wasn’t so obvious because in the interactive shell of python and python, the memory profiling packages that were recently installed were available. However, when running python (the same python) from the command-line, then it couldn’t find it. The fix was simply to add my python site-packages to the path. Should know in the future that the paths for the interactive vs command-line python can be different.</p>

<h3 id="heapy">Heapy</h3>

<p>So when I actually ran memprof, it ended up failing. I went through all the other packages and was able to get <a href="http://smira.ru/wp-content/uploads/2011/08/heapy.html">heapy</a> to work. The approach taken with heapy is to call an individual function to measure the memory usage, whereas the other approaches all use a decorator of some kind. It worked, but the RAM values all seemed a bit low and not very convenient to read, so I tried another approach.</p>

<h3 id="memprof">Memprof</h3>

<p>Now I’ll be looking at <a href="http://jmdana.github.io/memprof">Memprof</a>, recommended by Cameron and also on the <a href="http://stackoverflow.com/questions/110259/which-python-memory-profiler-is-recommended">stackoverflow page</a>. Since it won’t work with nipype, I manually ran the <code>calc_centrality</code> function. This approach gave me some memory read outs. However, because it doesn’t actually record the memory usage of a particular command (when all the correlations are calculated), the maximum memory is about 160 + 11 or 171MB in total. This is a lot lower than I calculated and much lower than what I saw in top, which maxed out at around 4GB.</p>

<p>[add pics]</p>

<h3 id="memory-profiler">Memory Profiler</h3>

<p>The other approach <a href="https://pypi.python.org/pypi/memory_profiler">memory_profiler</a> was a bit more useful. It showed about 1.4gb being used at the peak (around the correlation calculation).</p>

<h3 id="memtop">Memtop</h3>

<p>I also used a command-line tool <a href="http://www.webhostingtalk.com/showthread.php?t=1256200">memtop</a> that wraps around the command-line tool <code>ps</code>. This showed 4.2gb being used at the peak.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/blog/2013/11/20/wednesday-week-47/">Wednesday - Week 47</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2013-11-20T12:01:00-05:00" pubdate data-updated="true">Nov 20<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2 id="todo">TODO</h2>

<h3 id="centrality">Centrality</h3>

<ul>
  <li>xx Look to using 4mm grey-matter mask</li>
  <li>xx Run speed test on new analysis</li>
  <li></li>
</ul>

<h2 id="centrality-1">Centrality</h2>

<p>There a few issues related to needing to changing the inputs to the centrality nipype node. Those where straightforward.</p>

<p>Now I’m having some weird bug where the centrality outputs are not being saved. Trying to debug at the <code>map_centrality_matrix</code> function. Ended up being a simple typo and returning the template_type instead of centrality file outputs from the <code>calc_centrality</code> command.</p>

<p>I ran a comparison with AFNI’s 3dTcorrMap. When looking at the binarized result, almost all the voxels were the same except 8 in this particular case. I have tried doing centrality manually for those 8 voxels and keep getting the values from CPAC, which are 1 higher than the values from AFNI. I tried different correlation approaches as well as removing any voxel’s with constant time-series. However, since the difference is so small (only 1 for the binarized results) and there are so few voxels involved (8/19+k), I’m leaving it right now as a to be continued.</p>

<p>I ‘ve also changed the way the correlations are calculated. Now the time-series will all be first normalized and then a dot product will be computed. This is in contrast, to doing both steps all at once for each block that the correlation is computed. So this will be a much greater speed boon when there are many blocks. In a small speed comparison using the normalization approach leads to a 2x improvement in speed.</p>

<p>Although the setting of the block size does seem off, I will leave it for now. The actual amount of RAM being used is less than the amount </p>

<blockquote>
  <p>There were initially a lot more differences but a small change in the code to correct for auto-correlations in centrality took care of that issue.</p>
</blockquote>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/blog/2013/11/19/tuesday-week-47/">Tuesday - Week 47</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2013-11-19T10:53:00-05:00" pubdate data-updated="true">Nov 19<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2 id="todo">TODO</h2>

<h3 id="qc">QC</h3>

<ul>
  <li>Fix QC Pages</li>
  <li>Check QC output from Yang</li>
  <li>Do the QC</li>
</ul>

<h3 id="centrality-doneish">Centrality (<strong>DONEISH</strong>)</h3>

<ul>
  <li>Look at centrality code and diagnose possible improvements in efficiency</li>
  <li>Write up a bit on possible code changes</li>
  <li>Implement possible changes</li>
</ul>

<h3 id="abide-other-processing">ABIDE Other Processing</h3>

<ul>
  <li><strong>DONE</strong> Copy the other data into a new directory</li>
  <li>Create new generate quick pack scripts for the new data</li>
  <li>Talk to Chao-Gan about details of his results (ask him what the </li>
</ul>

<p>high reproducibility doesn’t necessary correlate with prediction value.</p>

<h2 id="centrality">Centrality</h2>

<h3 id="basics">Basics</h3>

<p>I want to first iron out some general questions:</p>

<ul>
  <li>What data is used by centrality? And what space is it in?</li>
  <li>How is the smoothing done?</li>
</ul>

<p>These steps can be seen in <a href="https://github.com/FCP-INDI/C-PAC/blob/master/CPAC/pipeline/cpac_pipeline.py"><code>pipeline/cpac_pipeline.py</code></a>.</p>

<h4 id="dataspace">Data/Space</h4>

<p>First, we find that the 4D functional data in standard space is used as an input as can be seen on line 3212:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">node</span><span class="p">,</span> <span class="n">out_file</span> <span class="o">=</span> <span class="n">strat</span><span class="o">.</span><span class="n">get_node_from_resource_pool</span><span class="p">(</span><span class="s">&#39;functional_mni&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>But it will resample that output in order to match the mask template based on some of the following lines:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">resample_functional_to_template</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">FLIRT</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;resample_functional_to_template_</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">num_strat</span><span class="p">)</span>
</span><span class="line"><span class="c"># …</span>
</span><span class="line"><span class="n">template_dataflow</span> <span class="o">=</span> <span class="n">create_mask_dataflow</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">templateSpecificationFile</span><span class="p">,</span> <span class="s">&#39;template_dataflow_</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">num_strat</span><span class="p">)</span>
</span><span class="line"><span class="c"># …</span>
</span><span class="line">
</span><span class="line"><span class="n">node</span><span class="p">,</span> <span class="n">out_file</span> <span class="o">=</span> <span class="n">strat</span><span class="o">.</span><span class="n">get_node_from_resource_pool</span><span class="p">(</span><span class="s">&#39;functional_mni&#39;</span><span class="p">)</span>
</span><span class="line"><span class="c"># resample the input functional file to template(roi/mask)</span>
</span><span class="line"><span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out_file</span><span class="p">,</span>
</span><span class="line">                 <span class="n">resample_functional_to_template</span><span class="p">,</span> <span class="s">&#39;in_file&#39;</span><span class="p">)</span>
</span><span class="line"><span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">template_dataflow</span><span class="p">,</span> <span class="s">&#39;outputspec.out_file&#39;</span><span class="p">,</span>
</span><span class="line">                 <span class="n">resample_functional_to_template</span><span class="p">,</span> <span class="s">&#39;reference&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>So the space is actually whatever your mask template is in.</p>

<h4 id="smoothing">Smoothing</h4>

<p>If smoothing is required, then it is applied to the centrality outputs from the prior step.</p>

<h3 id="centrality-workflow">Centrality Workflow</h3>

<p>Let’s figure out what’s going on with the centrality workflow located principally in <a href="https://github.com/FCP-INDI/C-PAC/blob/master/CPAC/network_centrality/resting_state_centrality.py"><code>network_centrality/resting_state_centrality.py</code></a>. The initial documentation is pretty good.</p>

<h3 id="load">Load</h3>

<p>It loads all the data as 32bit float so memory demands are decreased relative to float 64bit. While loading the data, it appears to save the masked functional time-series data as npy files. It’s not totally clear why this is needed by default. Furthermore, these 32bit files are later </p>

<h3 id="calculate-centrality">Calculate Centrality</h3>

<p>There are actually two functions for this step: <code>get_centrality</code> and <code>get_centrality_opt</code>. The first function saves the correlation matrix while the second function only saves for eigenvector centrality. In both approaches, I should check the correlation calculation and also how the block (to reduce memory) is implemented. It seems like the first function is called when there is need for a sparsity threshold and no memory limit is set.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">n2gb</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1024</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
</span><span class="line"><span class="n">nvoxs</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span class="line"><span class="n">ntpts</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span class="line"><span class="c">#</span>
</span><span class="line"><span class="n">mem_func</span> <span class="o">=</span> <span class="n">n2gb</span><span class="p">(</span><span class="n">nvoxs</span><span class="o">*</span><span class="n">ntpts</span><span class="p">)</span>
</span><span class="line"><span class="n">mem_result</span> <span class="o">=</span> <span class="n">n2gb</span><span class="p">(</span><span class="n">nvoxs</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
</span><span class="line"><span class="n">mem_cormaps</span> <span class="o">=</span> <span class="n">n2gb</span><span class="p">(</span><span class="n">nvoxs</span><span class="o">*</span><span class="mi">1</span><span class="p">)</span>
</span><span class="line"><span class="c">#</span>
</span><span class="line"><span class="c"># mem_limit = mem_func + mem_result + b*mem_cormaps</span>
</span><span class="line"><span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">mem_limit</span> <span class="o">-</span> <span class="n">mem_func</span> <span class="o">-</span> <span class="n">mem_result</span><span class="p">)</span><span class="o">/</span><span class="n">mem_cormaps</span>
</span><span class="line"><span class="c">#</span>
</span><span class="line"><span class="k">return</span> <span class="n">b</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="cpac-centrality---code-changes">CPAC Centrality - Code Changes</h2>

<p>Ok so let’s reorient. What do I want to do.</p>

<ul>
  <li>I want to do away with the step of saving an intermediate functional file. </li>
  <li>I want to improve the calculation of the memory limit (I think they are being overly conservative before)</li>
  <li>I want to change how the correlation is calculated</li>
</ul>

<h3 id="remove-saving-of-functionals">Remove saving of functionals</h3>

<h2 id="opening-writedown-easy">Opening WriteDown Easy</h2>

<p>I figured out that I’m slow and can actually open markdown files into WriteRoom from the command-line. For example:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">open -a WriteDown <span class="nb">source</span>/_posts/2013-11-19-tuesday-week-47.markdown
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>I made this even easier with a simple bash script so I can call the above command with</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">writedown <span class="nb">source</span>/_posts/2013-11-19-tuesday-week-47.markdown
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Thanks to the following link http://stackoverflow.com/questions/1308755/launch-an-app-on-os-x-with-command-line.</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/blog/2013/11/18/more-quick-pack-testing/">More Quick Pack Testing</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2013-11-18T14:01:00-05:00" pubdate data-updated="true">Nov 18<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2 id="changing-generation-of-yaml-file">Changing generation of yaml file</h2>

<p>I first worked on correcting the generation of the yml file with the file paths to the intermediate CPAC outputs from another run. I had to move away from using the symlinks folder to the sink folder due to errors in the symlinks folder. This might have also been a good move since hopefully it will make it easier for me to generate a quick pack file for Pierre and Xinian’s data.</p>

<p>Here is the new function that will build the file path to the intermediate files:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">def</span> <span class="nf">build_file_path</span><span class="p">(</span><span class="n">init_dir</span><span class="p">,</span> <span class="n">path_suffixes</span><span class="p">,</span> <span class="n">templ</span><span class="p">):</span>
</span><span class="line">    <span class="c"># Iterate through path suffixes, only keeping paths that exist</span>
</span><span class="line">    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path_suffixes</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span class="line">        <span class="n">path_suffixes</span> <span class="o">=</span> <span class="p">[</span><span class="n">path_suffixes</span><span class="p">]</span>
</span><span class="line">    <span class="n">file_path</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class="line">    <span class="k">for</span> <span class="n">path_suffix</span> <span class="ow">in</span> <span class="n">path_suffixes</span><span class="p">:</span>
</span><span class="line">        <span class="n">file_path</span> <span class="o">=</span> <span class="n">file_path</span> <span class="o">+</span> <span class="n">glob</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">init_dir</span><span class="p">,</span> <span class="n">path_suffix</span> <span class="o">%</span> <span class="n">templ</span><span class="p">))</span>
</span><span class="line">
</span><span class="line">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span class="line">        <span class="k">print</span> <span class="s">&quot;WARNING: Currently only one file for &#39;</span><span class="si">%s</span><span class="s">&#39; is supported&quot;</span> <span class="o">%</span> <span class="n">file_path</span>
</span><span class="line">        <span class="k">print</span> <span class="s">&quot;Choosing first one &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="n">file_path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span class="line">        <span class="n">file_path</span> <span class="o">=</span> <span class="n">file_path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span class="line">    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span class="line">        <span class="n">file_path</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
</span><span class="line">    <span class="k">else</span><span class="p">:</span>
</span><span class="line">        <span class="n">file_path</span> <span class="o">=</span> <span class="n">file_path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span class="line">    <span class="k">return</span> <span class="n">file_path</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="sample-yaml-output">Sample Yaml Output</h3>

<p>There’s a bunch of other code that I can get into later but here’s some output from one pipeline and strategy. This is from simply running <code>gen_quick_pack.py</code> in the <code>/home2/data/Projects/ABIDE_Initiative/CPAC/abide/config/test_quick_pack</code> folder.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="o">-</span> <span class="n">anat</span><span class="p">:</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">Projects</span><span class="o">/</span><span class="n">ABIDE_Initiative</span><span class="o">/</span><span class="n">CPAC</span><span class="o">/</span><span class="n">RawData</span><span class="o">/</span><span class="n">Caltech</span><span class="o">/</span><span class="mo">0051466</span><span class="o">/</span><span class="n">session_1</span><span class="o">/</span><span class="n">anat_1</span><span class="o">/</span><span class="n">mprage</span><span class="o">.</span><span class="n">nii</span><span class="o">.</span><span class="n">gz</span>
</span><span class="line">  <span class="n">anatomical_brain</span><span class="p">:</span> <span class="o">/</span><span class="n">home2</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">Projects</span><span class="o">/</span><span class="n">ABIDE_Initiative</span><span class="o">/</span><span class="n">CPAC</span><span class="o">/</span><span class="n">test_qp</span><span class="o">/</span><span class="n">All_Output</span><span class="o">/</span><span class="n">pipeline_MerrittIsland</span><span class="o">/</span><span class="mo">0051466</span><span class="n">_session_1</span><span class="o">/</span><span class="n">anatomical_brain</span><span class="o">/</span><span class="n">mprage_RPI_3dc</span><span class="o">.</span><span class="n">nii</span><span class="o">.</span><span class="n">gz</span>
</span><span class="line">  <span class="n">anatomical_reorient</span><span class="p">:</span> <span class="o">/</span><span class="n">home2</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">Projects</span><span class="o">/</span><span class="n">ABIDE_Initiative</span><span class="o">/</span><span class="n">CPAC</span><span class="o">/</span><span class="n">test_qp</span><span class="o">/</span><span class="n">All_Output</span><span class="o">/</span><span class="n">pipeline_MerrittIsland</span><span class="o">/</span><span class="mo">0051466</span><span class="n">_session_1</span><span class="o">/</span><span class="n">anatomical_reorient</span><span class="o">/</span><span class="n">mprage_RPI</span><span class="o">.</span><span class="n">nii</span><span class="o">.</span><span class="n">gz</span>
</span><span class="line">  <span class="n">anatomical_to_mni_nonlinear_xfm</span><span class="p">:</span> <span class="o">/</span><span class="n">home2</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">Projects</span><span class="o">/</span><span class="n">ABIDE_Initiative</span><span class="o">/</span><span class="n">CPAC</span><span class="o">/</span><span class="n">test_qp</span><span class="o">/</span><span class="n">All_Output</span><span class="o">/</span><span class="n">pipeline_MerrittIsland</span><span class="o">/</span><span class="mo">0051466</span><span class="n">_session_1</span><span class="o">/</span><span class="n">anatomical_to_mni_nonlinear_xfm</span><span class="o">/</span><span class="n">ants_Warp</span><span class="o">.</span><span class="n">nii</span><span class="o">.</span><span class="n">gz</span>
</span><span class="line">  <span class="n">ants_affine_xfm</span><span class="p">:</span> <span class="o">/</span><span class="n">home2</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">Projects</span><span class="o">/</span><span class="n">ABIDE_Initiative</span><span class="o">/</span><span class="n">CPAC</span><span class="o">/</span><span class="n">test_qp</span><span class="o">/</span><span class="n">All_Output</span><span class="o">/</span><span class="n">pipeline_MerrittIsland</span><span class="o">/</span><span class="mo">0051466</span><span class="n">_session_1</span><span class="o">/</span><span class="n">ants_affine_xfm</span><span class="o">/</span><span class="n">ants_Affine</span><span class="o">.</span><span class="n">txt</span>
</span><span class="line">  <span class="n">functional_brain_mask</span><span class="p">:</span> <span class="p">{</span><span class="n">rest_1_rest</span><span class="p">:</span> <span class="o">/</span><span class="n">home2</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">Projects</span><span class="o">/</span><span class="n">ABIDE_Initiative</span><span class="o">/</span><span class="n">CPAC</span><span class="o">/</span><span class="n">test_qp</span><span class="o">/</span><span class="n">All_Output</span><span class="o">/</span><span class="n">pipeline_MerrittIsland</span><span class="o">/</span><span class="mo">0051466</span><span class="n">_session_1</span><span class="o">/</span><span class="n">functional_brain_mask</span><span class="o">/</span><span class="n">_scan_rest_1_rest</span><span class="o">/</span><span class="n">rest_3dc_tshift_RPI_3dv_automask</span><span class="o">.</span><span class="n">nii</span><span class="o">.</span><span class="n">gz</span><span class="p">}</span>
</span><span class="line">  <span class="n">functional_brain_mask_to_standard</span><span class="p">:</span> <span class="p">{</span><span class="n">rest_1_rest</span><span class="p">:</span> <span class="o">/</span><span class="n">home2</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">Projects</span><span class="o">/</span><span class="n">ABIDE_Initiative</span><span class="o">/</span><span class="n">CPAC</span><span class="o">/</span><span class="n">test_qp</span><span class="o">/</span><span class="n">All_Output</span><span class="o">/</span><span class="n">pipeline_MerrittIsland</span><span class="o">/</span><span class="mo">0051466</span><span class="n">_session_1</span><span class="o">/</span><span class="n">functional_brain_mask_to_standard</span><span class="o">/</span><span class="n">_scan_rest_1_rest</span><span class="o">/</span><span class="n">rest_3dc_tshift_RPI_3dv_automask_wimt</span><span class="o">.</span><span class="n">nii</span><span class="o">.</span><span class="n">gz</span><span class="p">}</span>
</span><span class="line">  <span class="n">functional_freq_filtered</span><span class="p">:</span> <span class="p">{</span><span class="n">rest_1_rest</span><span class="p">:</span> <span class="o">/</span><span class="n">home2</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">Projects</span><span class="o">/</span><span class="n">ABIDE_Initiative</span><span class="o">/</span><span class="n">CPAC</span><span class="o">/</span><span class="n">test_qp</span><span class="o">/</span><span class="n">All_Output</span><span class="o">/</span><span class="n">pipeline_MerrittIsland</span><span class="o">/</span><span class="mo">0051466</span><span class="n">_session_1</span><span class="o">/</span><span class="n">functional_nuisance_residuals</span><span class="o">/</span><span class="n">_scan_rest_1_rest</span><span class="o">/</span><span class="n">_csf_threshold_0</span><span class="o">.</span><span class="mi">96</span><span class="o">/</span><span class="n">_gm_threshold_0</span><span class="o">.</span><span class="mi">7</span><span class="o">/</span><span class="n">_wm_threshold_0</span><span class="o">.</span><span class="mi">96</span><span class="o">/</span><span class="n">_compcor_ncomponents_5_selector_pc10</span><span class="o">.</span><span class="n">linear1</span><span class="o">.</span><span class="n">wm0</span><span class="o">.</span><span class="n">global0</span><span class="o">.</span><span class="n">motion1</span><span class="o">.</span><span class="n">quadratic1</span><span class="o">.</span><span class="n">gm0</span><span class="o">.</span><span class="n">compcor1</span><span class="o">.</span><span class="n">csf0</span><span class="o">/</span><span class="n">residual</span><span class="o">.</span><span class="n">nii</span><span class="o">.</span><span class="n">gz</span><span class="p">}</span>
</span><span class="line">  <span class="n">functional_mni</span><span class="p">:</span> <span class="p">{</span><span class="n">rest_1_rest</span><span class="p">:</span> <span class="o">/</span><span class="n">home2</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">Projects</span><span class="o">/</span><span class="n">ABIDE_Initiative</span><span class="o">/</span><span class="n">CPAC</span><span class="o">/</span><span class="n">test_qp</span><span class="o">/</span><span class="n">All_Output</span><span class="o">/</span><span class="n">pipeline_MerrittIsland</span><span class="o">/</span><span class="mo">0051466</span><span class="n">_session_1</span><span class="o">/</span><span class="n">functional_mni</span><span class="o">/</span><span class="n">_scan_rest_1_rest</span><span class="o">/</span><span class="n">_csf_threshold_0</span><span class="o">.</span><span class="mi">96</span><span class="o">/</span><span class="n">_gm_threshold_0</span><span class="o">.</span><span class="mi">7</span><span class="o">/</span><span class="n">_wm_threshold_0</span><span class="o">.</span><span class="mi">96</span><span class="o">/</span><span class="n">_compcor_ncomponents_5_selector_pc10</span><span class="o">.</span><span class="n">linear1</span><span class="o">.</span><span class="n">wm0</span><span class="o">.</span><span class="n">global0</span><span class="o">.</span><span class="n">motion1</span><span class="o">.</span><span class="n">quadratic1</span><span class="o">.</span><span class="n">gm0</span><span class="o">.</span><span class="n">compcor1</span><span class="o">.</span><span class="n">csf0</span><span class="o">/</span><span class="n">residual_wtsimt</span><span class="o">.</span><span class="n">nii</span><span class="o">.</span><span class="n">gz</span><span class="p">}</span>
</span><span class="line">  <span class="n">functional_nuisance_residuals</span><span class="p">:</span> <span class="p">{</span><span class="n">rest_1_rest</span><span class="p">:</span> <span class="o">/</span><span class="n">home2</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">Projects</span><span class="o">/</span><span class="n">ABIDE_Initiative</span><span class="o">/</span><span class="n">CPAC</span><span class="o">/</span><span class="n">test_qp</span><span class="o">/</span><span class="n">All_Output</span><span class="o">/</span><span class="n">pipeline_MerrittIsland</span><span class="o">/</span><span class="mo">0051466</span><span class="n">_session_1</span><span class="o">/</span><span class="n">functional_nuisance_residuals</span><span class="o">/</span><span class="n">_scan_rest_1_rest</span><span class="o">/</span><span class="n">_csf_threshold_0</span><span class="o">.</span><span class="mi">96</span><span class="o">/</span><span class="n">_gm_threshold_0</span><span class="o">.</span><span class="mi">7</span><span class="o">/</span><span class="n">_wm_threshold_0</span><span class="o">.</span><span class="mi">96</span><span class="o">/</span><span class="n">_compcor_ncomponents_5_selector_pc10</span><span class="o">.</span><span class="n">linear1</span><span class="o">.</span><span class="n">wm0</span><span class="o">.</span><span class="n">global0</span><span class="o">.</span><span class="n">motion1</span><span class="o">.</span><span class="n">quadratic1</span><span class="o">.</span><span class="n">gm0</span><span class="o">.</span><span class="n">compcor1</span><span class="o">.</span><span class="n">csf0</span><span class="o">/</span><span class="n">residual</span><span class="o">.</span><span class="n">nii</span><span class="o">.</span><span class="n">gz</span><span class="p">}</span>
</span><span class="line">  <span class="n">functional_to_anat_linear_xfm</span><span class="p">:</span> <span class="p">{</span><span class="n">rest_1_rest</span><span class="p">:</span> <span class="s">&#39;&#39;</span><span class="p">}</span>
</span><span class="line">  <span class="n">mean_functional</span><span class="p">:</span> <span class="p">{</span><span class="n">rest_1_rest</span><span class="p">:</span> <span class="o">/</span><span class="n">home2</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">Projects</span><span class="o">/</span><span class="n">ABIDE_Initiative</span><span class="o">/</span><span class="n">CPAC</span><span class="o">/</span><span class="n">test_qp</span><span class="o">/</span><span class="n">All_Output</span><span class="o">/</span><span class="n">pipeline_MerrittIsland</span><span class="o">/</span><span class="mo">0051466</span><span class="n">_session_1</span><span class="o">/</span><span class="n">mean_functional</span><span class="o">/</span><span class="n">_scan_rest_1_rest</span><span class="o">/</span><span class="n">rest_3dc_tshift_RPI_3dv_3dc_3dT</span><span class="o">.</span><span class="n">nii</span><span class="o">.</span><span class="n">gz</span><span class="p">}</span>
</span><span class="line">  <span class="n">mni_normalized_anatomical</span><span class="p">:</span> <span class="o">/</span><span class="n">home2</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">Projects</span><span class="o">/</span><span class="n">ABIDE_Initiative</span><span class="o">/</span><span class="n">CPAC</span><span class="o">/</span><span class="n">test_qp</span><span class="o">/</span><span class="n">All_Output</span><span class="o">/</span><span class="n">pipeline_MerrittIsland</span><span class="o">/</span><span class="mo">0051466</span><span class="n">_session_1</span><span class="o">/</span><span class="n">mni_normalized_anatomical</span><span class="o">/</span><span class="n">ants_deformed</span><span class="o">.</span><span class="n">nii</span><span class="o">.</span><span class="n">gz</span>
</span><span class="line">  <span class="n">preprocessed</span><span class="p">:</span> <span class="p">{</span><span class="n">rest_1_rest</span><span class="p">:</span> <span class="o">/</span><span class="n">home2</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">Projects</span><span class="o">/</span><span class="n">ABIDE_Initiative</span><span class="o">/</span><span class="n">CPAC</span><span class="o">/</span><span class="n">test_qp</span><span class="o">/</span><span class="n">All_Output</span><span class="o">/</span><span class="n">pipeline_MerrittIsland</span><span class="o">/</span><span class="mo">0051466</span><span class="n">_session_1</span><span class="o">/</span><span class="n">preprocessed</span><span class="o">/</span><span class="n">_scan_rest_1_rest</span><span class="o">/</span><span class="n">rest_3dc_tshift_RPI_3dv_3dc_maths</span><span class="o">.</span><span class="n">nii</span><span class="o">.</span><span class="n">gz</span><span class="p">}</span>
</span><span class="line">  <span class="n">rest</span><span class="p">:</span> <span class="p">{</span><span class="n">rest_1_rest</span><span class="p">:</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">Projects</span><span class="o">/</span><span class="n">ABIDE_Initiative</span><span class="o">/</span><span class="n">CPAC</span><span class="o">/</span><span class="n">RawData</span><span class="o">/</span><span class="n">Caltech</span><span class="o">/</span><span class="mo">0051466</span><span class="o">/</span><span class="n">session_1</span><span class="o">/</span><span class="n">rest_1</span><span class="o">/</span><span class="n">rest</span><span class="o">.</span><span class="n">nii</span><span class="o">.</span><span class="n">gz</span><span class="p">}</span>
</span><span class="line">  <span class="n">scan_parameters</span><span class="p">:</span> <span class="p">{</span><span class="n">acquisition</span><span class="p">:</span> <span class="n">alt</span><span class="o">+</span><span class="n">z</span><span class="p">,</span> <span class="n">first_tr</span><span class="p">:</span> <span class="s">&#39;0&#39;</span><span class="p">,</span> <span class="n">last_tr</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="n">reference</span><span class="p">:</span> <span class="s">&#39;17&#39;</span><span class="p">,</span>
</span><span class="line">    <span class="n">tr</span><span class="p">:</span> <span class="s">&#39;2&#39;</span><span class="p">}</span>
</span><span class="line">  <span class="n">subject_id</span><span class="p">:</span> <span class="s">&#39;0051466&#39;</span>
</span><span class="line">  <span class="n">unique_id</span><span class="p">:</span> <span class="n">session_1</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="first-wave-of-testing-using-alff">First Wave of Testing using ALFF</h2>

<p>Now I am trying to test the running of CPAC for the various derivatives using the quick pack generated files like that above. I run quick pack using the following command <code>run_quick_pack.py</code>. I ran the quick pack using inputs where there was no filtering but there was global signal correction.</p>

<p><strong>nofilt_global</strong></p>

<h3 id="first-run">First Run</h3>

<p>I did get an error that ended up being a missing path for <code>functional_to_anat_linear_xfm.mat</code>. I added a warning to deal with a future empty path. I also fixed the path.</p>

<h3 id="second-run">Second Run</h3>

<p>Trying my hand again, it ran smoothly! Woot woot. But wait.</p>

<h3 id="third-run">Third Run</h3>

<p>Ok this time it should be good. I noticed one mistake where for my paths I had inverted global and no global correction. Quick redo and stuff again appears to have run smoothly.</p>

<h3 id="testing">Testing</h3>

<p>I will run the following file in R <code>/home2/data/Projects/ABIDE_Initiative/CPAC/abide/tests/quickpack/compare_10_alff.R</code>.</p>

<p>This was all good.</p>

<h2 id="other-tests">Other Tests</h2>

<p>The tests for all the other derivatives were all good. So we are good to move forward.</p>

<h2 id="next-steps">Next Steps</h2>

<p>This isn’t really meant for this section but the next items for ABIDE and QuickPack are</p>

<ul>
  <li>Fix QC Pages</li>
  <li>Check QC output from Yang</li>
  <li>
    <p>Do the QC</p>
  </li>
  <li>
    <p>Look at the centrality code and make more efficient if possible</p>
  </li>
  <li>Copy the other data into a new directory</li>
  <li>Create new generate quick pack scripts for the new data</li>
</ul>

<h2 id="confirming-input-to-centrality">Confirming input to centrality</h2>

<p>Also should be moved to a different page. But I have confirmed that the centrality node uses the functional data from standard space and at the very least the 4D functional data must be in the same space as the prior mask.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    
  

<section>
  <h1>Tag Cloud</h1>
    <span id="tag-cloud"><a href='/blog/categories/abide' style='font-size: 160.0%'>abide(7)</a> <a href='/blog/categories/cmi' style='font-size: 117.14285714285714%'>cmi(2)</a> <a href='/blog/categories/cpac' style='font-size: 160.0%'>cpac(7)</a> <a href='/blog/categories/cwas' style='font-size: 160.0%'>cwas(7)</a> <a href='/blog/categories/emotional-bs' style='font-size: 117.14285714285714%'>emotional-bs(2)</a> <a href='/blog/categories/jekyll' style='font-size: 108.57142857142857%'>jekyll(1)</a> <a href='/blog/categories/mdmr' style='font-size: 108.57142857142857%'>mdmr(1)</a> <a href='/blog/categories/nilearn' style='font-size: 125.71428571428572%'>nilearn(3)</a> <a href='/blog/categories/quickpack' style='font-size: 151.42857142857144%'>quickpack(6)</a> <a href='/blog/categories/writedown' style='font-size: 108.57142857142857%'>writedown(1)</a> </span>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/11/25/updating-centrality/">Updating Centrality</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/11/25/monday-week-48/">Monday - Week 48</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/11/24/timing-comparison/">Timing Comparison</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/11/24/similarity-of-iq-cwas-across-scans/">Similarity of IQ CWAS Across Scans</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/11/23/saturday-week-47/">Saturday - Week 47</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/czarrar">@czarrar</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'czarrar',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>My Pinboard</h1>
  <ul id="pinboard_linkroll">Fetching linkroll&#8230;</ul>
  <p><a href="http://pinboard.in/u:czarrar">My Pinboard Bookmarks &raquo;</a></p>
</section>
<script type="text/javascript">
  var linkroll = 'pinboard_linkroll'; //id target for pinboard list
  var pinboard_user = "czarrar"; //id target for pinboard list
  var pinboard_count = 3; //id target for pinboard list
  (function(){
    var pinboardInit = document.createElement('script');
    pinboardInit.type = 'text/javascript';
    pinboardInit.async = true;
    pinboardInit.src = '/javascripts/pinboard.js';
    document.getElementsByTagName('head')[0].appendChild(pinboardInit);
  })();
</script>

<!--
    Calendar aside/plugin for octopress blogging framework.
    Copyright (C) 2012  Neeraj Kumar ( neerajpkumar@gmail.com, neerajkumar@outlook.com)

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.
&#8211;>
<style>
	.highlighted-calendar-day
	{
		color : #CCC;
		font-weight : bold;
	}
	
	.calendar-header-day{
		font-weight : bold;
		color : #AAA;
		font-size : 14px;
	}
	
	.highlighted-calendar-day a
	{
		
	}
	
	.prev-link
	{
		float:left;
	}
	
	.next-link
	{
		float: right;
	}
	.calendar-day
	{
		color : #888;
		font-weight : 12px;
	}
	
	.calendar-table
	{
		width : 100%;
		
	}
	
	.calendar-table td
	{
		border-right : dotted 1px lightgrey;
		text-align : center;
	}
	
	.calendar-table td:last-child
	{
		border-right : none;
	}
	
	.calendar-table th
	{
		background-color : lightgrey;
		text-align : center;
	}
	.prevCalendarLink img
	{	
		
		width : 20px;
		height : 20px;
		border: 0px;
		float: left;
		
	}
	
	.nextCalendarLink img
	{
		
		width : 20px;
		height: 20px;
		border: 0px;
		float: right;
		
	}
</style>
<script type="text/javascript" src="/javascripts/calendar.js"></script>
<section id="calendarDiv">
	<h1>Calendar</h1>
	<span style="display:block" id="calendarSpan"></span>
	<div>
		<a href="#" class="previousMonth show"/><a href="#" class="nextMonth hide"/>
	</div>
</section>
<script type="text/javascript">
  
monthCalendar = function(id,year,month)
{
  var highlightArray = new Array();
  var hightlightLinks = new Array();
  
  highlightArray.push('11/25/2013');
  hightlightLinks.push('/blog/2013/11/25/updating-centrality/');
  
  highlightArray.push('11/25/2013');
  hightlightLinks.push('/blog/2013/11/25/monday-week-48/');
  
  highlightArray.push('11/24/2013');
  hightlightLinks.push('/blog/2013/11/24/timing-comparison/');
  
  highlightArray.push('11/24/2013');
  hightlightLinks.push('/blog/2013/11/24/similarity-of-iq-cwas-across-scans/');
  
  highlightArray.push('11/23/2013');
  hightlightLinks.push('/blog/2013/11/23/saturday-week-47/');
  		
  var cal = new Calendar(month,year,highlightArray,hightlightLinks);
  cal.generateHTML(id);
  var element = document.getElementById(id);
  element.innerHTML = cal.getHTML();
}
	
loadCalendar = function(){
  var now = new Date();
  var month = now.getMonth();
  var year = now.getFullYear();
  monthCalendar('calendarDiv',year,month);
}
	
	if(Array.prototype.indexOf == undefined)
	{
		 Array.prototype.indexOf = function (searchElement /*, fromIndex */ ) {
			"use strict";
			if (this == null) {
				throw new TypeError();
			}
			var t = Object(this);
			var len = t.length >>> 0;
			if (len === 0) {
				return -1;
			}
			var n = 0;
			if (arguments.length > 0) {
				n = Number(arguments[1]);
				if (n != n) { // shortcut for verifying if it's NaN
					n = 0;
				} else if (n != 0 && n != Infinity && n != -Infinity) {
					n = (n > 0 || -1) * Math.floor(Math.abs(n));
				}
			}
			if (n >= len) {
				return -1;
			}
			var k = n >= 0 ? n : Math.max(len - Math.abs(n), 0);
			for (; k < len; k++) {
				if (k in t && t[k] === searchElement) {
					return k;
				}
			}
			return -1;
		}
	}
$(document).ready(function(){
  loadCalendar();
});
</script>

  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Zarrar Shehzad -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
